name: Deploy

on: 
  release:
    types:
      - prereleased

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.get_pkg_version.outputs.package_version }}
      tag_version: ${{ steps.get_pkg_version.outputs.tag_version }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: Get package version
        id: get_pkg_version
        run: |
          TAG_VERSION=$(echo ${{ github.ref }} | cut -d "/" -f 3)
          PKG_VERSION=${TAG_VERSION:1}

          echo "::set-output name=package_version::$PKG_VERSION"
          echo "::set-output name=tag_version::$TAG_VERSION"


  linux:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      #- name: Install Snap
      #  uses: samuelmeuli/action-snapcraft@v1
      #  with:
      #    snapcraft_token: ${{ secrets.SNAP_TOKEN }}

      - name: Get snap release asset
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: tags/${{ env.TAG_VERSION }}
          file: bitwarden_${{ env.PKG_VERSION }}_amd64.snap
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          PKG_VERSION: ${{ needs.setup.outputs.package_version }}
          TAG_VERSION: ${{ needs.setup.outputs.tag_version }}

      - name: testing
        run: ls -atlh

      #- name: Deploy to Snap Store
      #  run: |
      #    snapcraft upload dist/bitwarden_${{ env.PACKAGE_VERSION }}_amd64.snap --release stable
      #    snapcraft logout

